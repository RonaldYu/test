name: Deploy Trigger in Azure Data Factory (Create/Update, Start/Stop or Delete)
run-name: "Deploy Trigger in Azure Data Factory | ${{ github.event.inputs.adf_name }} | ${{ github.event.inputs.adf_trigger_type}} | ${{ github.event.inputs.adf_trigger_deploy_action }}"
on:
  workflow_dispatch:
    inputs:
      
      resource_group_name:
        required: true
        type: string
        description: "The name of the resource group"
      
      adf_name:
        required: true
        type: string
        description: "The name of the Azure Data Factory"
      adf_trigger_type:
        required: true
        type: choice
        description: "The trigger type in AIPIL to deploy"
        options:
          - overallorch-trigger
      adf_trigger_deploy_action:
        required: true
        type: choice
        description: "The action to create/update, start/stop, or delete the trigger"
        options:
          - create
          - update
          - start
          - stop
          - delete
      enable_auto_start:
        required: false
        type: choice
        description: "Whether to enable auto start of the trigger after creation or update"
        options:
          - "true"
          - "false"
        default: "false"
      is_required_apim_subscription_key:
        required: false
        type: choice
        description: "Whether the APIM subscription key is required"
        options:
          - "true"
          - "false"
        default: "false"
jobs:
  
  deploy-adf-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display workflow inputs
        run: |
          echo "## Workflow Inputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Input | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group Name | ${{ github.event.inputs.resource_group_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure Data Factory Name | ${{ github.event.inputs.adf_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger Type | ${{ github.event.inputs.adf_trigger_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Action | ${{ github.event.inputs.adf_trigger_deploy_action }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enable Auto Start | ${{ github.event.inputs.enable_auto_start }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Required APIM Subscription Key | ${{ github.event.inputs.is_required_apim_subscription_key }} |" >> $GITHUB_STEP_SUMMARY

      - name: Set dynamic values based on the input values
        id: set_env_config
        run: |

          TRIGGER_TYPE="${{ github.event.inputs.adf_trigger_type }}"
          case "$TRIGGER_TYPE" in
            overallorch-trigger)
              adf_trigger_pth="adf/trigger/aipil-datapipe-overallorch-trigger.json"
              ;;
            *) 
              echo "Invalid trigger type: $TRIGGER_TYPE"
              exit 1
              ;;
          esac

          echo "adf_trigger_pth=$adf_trigger_pth" >> $GITHUB_OUTPUT

          DEPLOY_ACTION="${{ github.event.inputs.adf_trigger_deploy_action }}"
          case "$DEPLOY_ACTION" in
            create)
              adf_trigger_deploy_action="create"
              ;;
            update)
              adf_trigger_deploy_action="update"
              ;;
            start)
              adf_trigger_deploy_action="start"
              ;;
            stop)
              adf_trigger_deploy_action="stop"
              ;;
            delete)
              adf_trigger_deploy_action="delete"
              ;;
            *)
              echo "Invalid deploy action: $DEPLOY_ACTION"
              exit 1
              ;;
          esac

          echo "adf_trigger_deploy_action=$adf_trigger_deploy_action" >> $GITHUB_OUTPUT

      - name: Deploy trigger in Azure Data Factory
        id: deploy_adf_trigger
        uses: ./actions/deploy-adf-trigger
        with:
          adf_name: ${{ github.event.inputs.adf_name }}
          adf_resource_group: ${{ github.event.inputs.resource_group_name }}
          sp_app_id: ${{ vars.SP_USERNAME }}
          sp_tenant_id: ${{ vars.SP_TENANTID }}
          sp_secret: ${{ secrets.SP_PASSWORD }}
          adf_trigger_pth: ${{ steps.set_env_config.outputs.adf_trigger_pth }}
          adf_trigger_deploy_action: ${{ steps.set_env_config.outputs.adf_trigger_deploy_action }}
          enable_auto_start: ${{ github.event.inputs.enable_auto_start }}
          secret_placeholder_1: ${{ github.event.inputs.is_required_apim_subscription_key == 'true' && vars.APIM_SUBSCRIPTION_KEY_PLACEHOLDER || '' }}
          secret_value_1: ${{ github.event.inputs.is_required_apim_subscription_key == 'true' && secrets.APIM_SUBSCRIPTION_KEY || '' }}

      
